<!DOCTYPE html>

<html lang="en" class="js">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<title>Drag and Drop File Uploading</title>
	<link rel="stylesheet" href="./styles/uploader.css">

</head>

<body>

	<div class="container" role="main">

		<form method="post" id="upload-box" action="#" enctype="multipart/form-data" novalidate class="box">

			<div class="box__input">
				<svg data-prefix="fas" data-icon="cloud-upload" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="svg-inline--fa fa-cloud-upload fa-w-20 fa-7x box__icon">
					<path fill="currentColor" d="M537.585 226.56C541.725 215.836 544 204.184 544 192c0-53.019-42.981-96-96-96-19.729 0-38.065 5.954-53.316 16.159C367.042 64.248 315.288 32 256 32c-88.365 0-160 71.634-160 160 0 2.728.07 5.439.204 8.133C40.171 219.845 0 273.227 0 336c0 79.529 64.471 144 144 144h368c70.692 0 128-57.308 128-128 0-61.93-43.983-113.586-102.415-125.44zm-139.928 63.783l-10.775 10.775c-9.58 9.581-25.187 9.337-34.464-.539L320 266.067V392c0 13.255-10.745 24-24 24h-16c-13.255 0-24-10.745-24-24V266.067l-32.419 34.512c-9.276 9.875-24.883 10.119-34.464.539l-10.775-10.775c-9.373-9.373-9.372-24.568 0-33.941l92.686-92.686c9.373-9.373 24.568-9.373 33.941 0l92.687 92.686c9.374 9.372 9.374 24.568.001 33.941z"
					 class=""></path>
				</svg>
				<input type="file" name="files[]" id="file" class="box__file" data-multiple-caption="{count} files selected" multiple />

				<div style="position:relative; margin-left:auto;margin-right:auto">
					<label for="file">
						<strong>Choose a file</strong>
						<span class="box__dragndrop"> or drag it here</span>.
					</label>
					<br />
					<a id="controlButton" href="#" class="progress-button" onclick="upload('/test/index.php')">
						Upload
					</a>
				</div>

				<div id="progressBar"></div>
			</div>
		</form>

	</div>

	<script src="js/uploader.js" type="text/javascript"></script>
	<script src="js/jquery-3.2.1.min.js" type="text/javascript"></script>
	<script src="js/script.js" type="text/javascript"></script>

	<script type="text/javascript">
		var xhr;
		var ot;//
		var oloaded;

		function upload(url) {
			var fileObj = document.getElementById("upload-box").files[0]; // js 获取文件对象			
			var form = new FormData(); // FormData 对象

			form.append("mf", fileObj); // 文件对象

			xhr = new XMLHttpRequest();  // XMLHttpRequest 对象
			xhr.open("post", url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
			xhr.onload = uploadComplete; //请求完成
			xhr.onerror = uploadFailed; //请求失败
			xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
			xhr.upload.onloadstart = function () {//上传开始执行方法
				ot = new Date().getTime();   //设置上传开始时间
				oloaded = 0;//设置上传开始时，以上传的文件大小为0
			};
			xhr.send(form); //开始上传，发送form数据
		}

		function progressFunction(evt) {

			var progressBar = document.getElementById("progressBar");
			var percentage = 0;

			// event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable不为真，则event.total等于0
			if (evt.lengthComputable) {//
				progressBar.max = evt.total;
				progressBar.value = evt.loaded;

				percentage = Math.round(evt.loaded / evt.total * 100);
			}

			var nt = new Date().getTime();//获取当前时间
			var pertime = (nt - ot) / 1000; //计算出上次调用该方法时到现在的时间差，单位为s
			ot = new Date().getTime(); //重新赋值时间，用于下次计算

			var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b       
			oloaded = evt.loaded;//重新赋值已上传文件大小，用以下次计算

			//上传速度计算
			var speed = perload / pertime;//单位b/s
			var bspeed = speed;
			var units = 'b/s';//单位名称
			if (speed / 1024 > 1) {
				speed = speed / 1024;
				units = 'k/s';
			}
			if (speed / 1024 > 1) {
				speed = speed / 1024;
				units = 'M/s';
			}
			speed = speed.toFixed(1);
			//剩余时间
			var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);
			progressBar.innerHTML = percentage + "%" + '，速度：' + speed + units + '，剩余时间：' + resttime + 's';
			
			var controlButton = $('#controlButton');
			controlButton.progressSet(percentage);

			if (bspeed == 0)
				time.innerHTML = '上传已取消';
		}
		//上传成功响应
		function uploadComplete(evt) {
			//服务断接收完文件返回的结果
			//    alert(evt.target.responseText);
			var controlButton = $('#controlButton');
			controlButton.progressFinish();
		}
		//上传失败
		function uploadFailed(evt) {
			
		}
		//取消上传
		function cancleUploadFile() {
			xhr.abort();
		}
	</script>
</body>

</html>